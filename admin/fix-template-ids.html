<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fix Template - Map Names to IDs</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 900px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #2d3748; }
        .btn { background: #10b981; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .btn:hover { background: #059669; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 11px; max-height: 500px; }
        .mapping { background: #f0fdf4; padding: 10px; margin: 5px 0; border-radius: 4px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Fix Template - Map Names to Player IDs</h1>
        <p>This will look up all players and create proper ID mappings for the template.</p>
        
        <div id="status" class="status info">Connecting...</div>
        
        <button class="btn" onclick="loadAndFix()">ðŸ”§ Load Players & Fix Everything</button>
        
        <h3>Player Mappings:</h3>
        <div id="mappings"></div>
        
        <pre id="output" style="display:none;"></pre>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-qLLcm3_oKk1soGsSQui38dM-9M8BN14",
            authDomain: "matchpoint-e5b00.firebaseapp.com",
            projectId: "matchpoint-e5b00",
            storageBucket: "matchpoint-e5b00.firebasestorage.app",
            messagingSenderId: "145208722794",
            appId: "1:145208722794:web:b6f46e386445321019d113"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        firebase.auth().signInAnonymously()
            .then(() => {
                document.getElementById('status').textContent = 'âœ… Connected';
                document.getElementById('status').className = 'status success';
            });
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getWeekMonday(weekOffset) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + diff + (weekOffset * 7));
            monday.setHours(0, 0, 0, 0);
            return monday;
        }
        
        async function loadAndFix() {
            document.getElementById('status').textContent = 'â³ Loading players...';
            document.getElementById('status').className = 'status info';
            
            try {
                // 1. Load all players
                const playersSnapshot = await db.collection('players').get();
                const playerMap = {};
                const nameToId = {};
                
                playersSnapshot.forEach(doc => {
                    const data = doc.data();
                    playerMap[doc.id] = data.name;
                    // Create reverse mapping (name -> id)
                    // Handle variations
                    nameToId[data.name] = doc.id;
                    nameToId[data.name.toLowerCase()] = doc.id;
                });
                
                console.log('Players loaded:', playerMap);
                
                // Show mappings
                let mappingsHtml = '';
                for (const [id, name] of Object.entries(playerMap)) {
                    mappingsHtml += `<div class="mapping">${name} â†’ ${id}</div>`;
                }
                document.getElementById('mappings').innerHTML = mappingsHtml;
                
                // 2. Define the template with NAMES, we'll convert to IDs
                const templateNames = {
                    tuesday: {
                        '20:00-21:00': ['Viktorija', 'Nikola', 'Liza', 'KristÄ«ne S.'],
                        '21:00-22:00': ['Karina', 'JÅ«lija', 'Sintija', 'LÄ«va', 'Rita']
                    },
                    thursday: {
                        '20:00-21:00': ['Agnese', 'Kristaps', 'Elza', 'Aivars', 'Arta'],
                        '21:00-22:00': ['Edgars', 'KlÄvs', 'JÄnis', 'RiÄards']
                    }
                };
                
                // 3. Convert names to IDs
                function findPlayerId(name) {
                    // Direct match
                    if (nameToId[name]) return nameToId[name];
                    // Lowercase match
                    if (nameToId[name.toLowerCase()]) return nameToId[name.toLowerCase()];
                    // Partial match
                    for (const [pName, pId] of Object.entries(nameToId)) {
                        if (pName.toLowerCase().includes(name.toLowerCase()) || 
                            name.toLowerCase().includes(pName.toLowerCase())) {
                            return pId;
                        }
                    }
                    console.warn('No match for:', name);
                    return null;
                }
                
                const templateWithIds = {
                    tuesday: {
                        '20:00-21:00': { players: [], instructor: 'PaÅ¡a' },
                        '21:00-22:00': { players: [], instructor: 'PaÅ¡a' }
                    },
                    thursday: {
                        '20:00-21:00': { players: [], instructor: 'JustÄ«ne' },
                        '21:00-22:00': { players: [], instructor: 'JustÄ«ne' }
                    }
                };
                
                const notFound = [];
                
                for (const day of ['tuesday', 'thursday']) {
                    for (const time of ['20:00-21:00', '21:00-22:00']) {
                        const names = templateNames[day][time];
                        const ids = [];
                        for (const name of names) {
                            const id = findPlayerId(name);
                            if (id) {
                                ids.push(id);
                            } else {
                                notFound.push(name);
                            }
                        }
                        templateWithIds[day][time].players = ids;
                    }
                }
                
                if (notFound.length > 0) {
                    console.warn('Players not found:', notFound);
                }
                
                console.log('Template with IDs:', templateWithIds);
                
                // 4. Save updated template
                await db.collection('seasonTemplate').doc('default').set({
                    ...templateWithIds,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    seasonStart: '2026-02-01',
                    seasonEnd: '2026-04-30',
                    description: 'Feb-Apr 2026 (with player IDs)'
                });
                
                console.log('âœ… Template saved with IDs');
                
                // 5. Apply to future schedules
                const batch = db.batch();
                let count = 0;
                const today = formatDate(new Date());
                
                for (let w = 0; w < 12; w++) {
                    const monday = getWeekMonday(w);
                    const tuesday = new Date(monday);
                    tuesday.setDate(monday.getDate() + 1);
                    const thursday = new Date(monday);
                    thursday.setDate(monday.getDate() + 3);
                    
                    const tueDate = formatDate(tuesday);
                    const thuDate = formatDate(thursday);
                    
                    if (tueDate > '2026-04-30') break;
                    if (tueDate < today) continue;
                    
                    const sessions = [
                        { date: tueDate, day: 'tuesday', time: '20:00-21:00', instructor: 'PaÅ¡a' },
                        { date: tueDate, day: 'tuesday', time: '21:00-22:00', instructor: 'PaÅ¡a' },
                        { date: thuDate, day: 'thursday', time: '20:00-21:00', instructor: 'JustÄ«ne' },
                        { date: thuDate, day: 'thursday', time: '21:00-22:00', instructor: 'JustÄ«ne' }
                    ];
                    
                    for (const s of sessions) {
                        const sessionId = `${s.date}-${s.day}-${s.time}`;
                        const playerIds = templateWithIds[s.day][s.time].players;
                        
                        batch.set(db.collection('schedules').doc(sessionId), {
                            date: s.date,
                            day: s.day,
                            time: s.time,
                            instructor: s.instructor,
                            players: playerIds,
                            maxCapacity: 5,
                            locked: false,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        count++;
                    }
                }
                
                await batch.commit();
                
                document.getElementById('status').textContent = `âœ… Fixed! Template saved and applied to ${count} sessions`;
                document.getElementById('status').className = 'status success';
                
                document.getElementById('output').style.display = 'block';
                document.getElementById('output').textContent = 
                    'Template with IDs:\n' + JSON.stringify(templateWithIds, null, 2) +
                    '\n\nNot found: ' + JSON.stringify(notFound);
                    
            } catch (e) {
                document.getElementById('status').textContent = 'âŒ Error: ' + e.message;
                document.getElementById('status').className = 'status error';
                console.error(e);
            }
        }
    </script>
</body>
</html>
