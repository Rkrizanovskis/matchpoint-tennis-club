<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Initialize Season</title>
    
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #2d3748; margin-top: 0; }
        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            font-weight: 600;
        }
        .btn:hover { background: #2563eb; }
        .btn.success { background: #10b981; }
        .btn.success:hover { background: #059669; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .progress {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 20px 0;
            display: none;
        }
        .log-entry {
            margin: 3px 0;
            padding: 2px 0;
        }
        .log-entry.success { color: #4ade80; }
        .log-entry.error { color: #f87171; }
        .log-entry.warning { color: #fbbf24; }
        .log-entry.info { color: #60a5fa; }
        .summary {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .summary-item:last-child { border-bottom: none; }
        .summary-value {
            font-weight: 600;
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Bulk Initialize Season Schedule</h1>
        
        <div class="info-box">
            <strong>‚ÑπÔ∏è Date Range:</strong> October 4, 2025 ‚Üí January 1, 2026
            <br>
            <strong>Total Weeks:</strong> <span id="totalWeeks">Calculating...</span>
        </div>
        
        <div class="warning">
            <strong>‚ö†Ô∏è This will:</strong>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>Apply the season template to ALL weeks in the date range</li>
                <li>Delete and replace any existing schedule data for these weeks</li>
                <li>Cannot be undone (but you can re-run if needed)</li>
            </ul>
        </div>
        
        <div id="status" class="status info">
            Connecting to Firebase...
        </div>
        
        <div class="summary" id="summary" style="display: none;">
            <h3 style="margin-top: 0;">Preview</h3>
            <div class="summary-item">
                <span>Start Week:</span>
                <span class="summary-value" id="startWeek">-</span>
            </div>
            <div class="summary-item">
                <span>End Week:</span>
                <span class="summary-value" id="endWeek">-</span>
            </div>
            <div class="summary-item">
                <span>Total Weeks:</span>
                <span class="summary-value" id="weeksCount">-</span>
            </div>
            <div class="summary-item">
                <span>Schedule Slots per Week:</span>
                <span class="summary-value">4 (Tue/Thu @ 20:00, 21:00)</span>
            </div>
            <div class="summary-item">
                <span>Total Slots to Initialize:</span>
                <span class="summary-value" id="totalSlots">-</span>
            </div>
        </div>
        
        <div>
            <button class="btn" onclick="previewInitialization()" id="previewBtn">
                üëÅÔ∏è Preview Initialization
            </button>
            
            <button class="btn success" onclick="runBulkInitialization()" id="runBtn" disabled>
                üöÄ Initialize All Weeks
            </button>
        </div>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>
        
        <div class="log-container" id="logContainer"></div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let database = null;
        let weeksList = [];
        
        // Initialize Firebase
        async function init() {
            try {
                await firebase.auth().signInAnonymously();
                database = firebase.firestore();
                updateStatus('‚úÖ Connected to Firebase', 'success');
                calculateWeeks();
            } catch (error) {
                updateStatus('‚ùå Failed to connect: ' + error.message, 'error');
            }
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            container.style.display = 'block';
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(entry);
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        function updateProgress(current, total) {
            const fill = document.getElementById('progressFill');
            const percent = Math.round((current / total) * 100);
            fill.style.width = percent + '%';
            fill.textContent = `${percent}% (${current}/${total})`;
        }
        
        // Helper functions
        function formatDateForId(date) {
            return date.toISOString().split('T')[0];
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }
        
        function getSessionId(date, day, time) {
            return `${date}-${day}-${time}`;
        }
        
        // Calculate all weeks between Oct 4, 2025 and Jan 1, 2026
        function calculateWeeks() {
            const startDate = new Date('2025-10-04'); // Friday, Oct 4
            const endDate = new Date('2026-01-01');
            
            weeksList = [];
            
            // Find the Monday of the week containing Oct 4
            let currentMonday = new Date(startDate);
            const dayOfWeek = currentMonday.getDay();
            const diff = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek;
            currentMonday.setDate(startDate.getDate() + diff);
            currentMonday.setHours(0, 0, 0, 0);
            
            // Generate all weeks until we reach a week that starts after Jan 1, 2026
            while (currentMonday < endDate) {
                const weekEnd = new Date(currentMonday);
                weekEnd.setDate(currentMonday.getDate() + 3); // Thursday
                
                weeksList.push({
                    monday: new Date(currentMonday),
                    thursday: weekEnd
                });
                
                // Move to next week
                currentMonday.setDate(currentMonday.getDate() + 7);
            }
            
            document.getElementById('totalWeeks').textContent = weeksList.length + ' weeks';
            log(`Calculated ${weeksList.length} weeks from ${formatDate(weeksList[0].monday)} to ${formatDate(weeksList[weeksList.length-1].thursday)}`, 'success');
        }
        
        // Preview what will be initialized
        async function previewInitialization() {
            updateStatus('‚è≥ Generating preview...', 'info');
            
            try {
                // Check if template exists
                const templateDoc = await database.collection('seasonTemplate').doc('default').get();
                
                if (!templateDoc.exists) {
                    updateStatus('‚ùå No template found! Create a template first.', 'error');
                    alert('Error: No season template found!\n\nPlease create a template first using template-manager.html');
                    return;
                }
                
                const template = templateDoc.data();
                
                // Count players in template
                let playersInTemplate = 0;
                ['tuesday', 'thursday'].forEach(day => {
                    ['20:00-21:00', '21:00-22:00'].forEach(time => {
                        if (template[day] && template[day][time]) {
                            playersInTemplate += (template[day][time].players || []).length;
                        }
                    });
                });
                
                // Show summary
                document.getElementById('summary').style.display = 'block';
                document.getElementById('startWeek').textContent = formatDate(weeksList[0].monday);
                document.getElementById('endWeek').textContent = formatDate(weeksList[weeksList.length-1].thursday);
                document.getElementById('weeksCount').textContent = weeksList.length;
                document.getElementById('totalSlots').textContent = weeksList.length * 4;
                
                updateStatus(`‚úÖ Preview ready! Template has ${playersInTemplate} total player bookings.`, 'success');
                
                // Enable run button
                document.getElementById('runBtn').disabled = false;
                
                log(`Template loaded with ${playersInTemplate} player bookings`, 'success');
                log(`Ready to initialize ${weeksList.length} weeks (${weeksList.length * 4} slots)`, 'info');
                
            } catch (error) {
                updateStatus('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // Run bulk initialization
        async function runBulkInitialization() {
            const confirmed = confirm(
                `‚ö†Ô∏è FINAL CONFIRMATION\n\n` +
                `This will initialize ${weeksList.length} weeks (${weeksList.length * 4} slots) with the current template.\n\n` +
                `Any existing schedule data for these weeks will be DELETED and REPLACED.\n\n` +
                `Continue?`
            );
            
            if (!confirmed) return;
            
            // Disable buttons
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('runBtn').disabled = true;
            
            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0, weeksList.length);
            
            updateStatus('‚è≥ Initializing weeks... Please wait.', 'info');
            log('üöÄ Starting bulk initialization...', 'info');
            
            try {
                // Load template
                const templateDoc = await database.collection('seasonTemplate').doc('default').get();
                const template = templateDoc.data();
                
                const days = ['tuesday', 'thursday'];
                const timeSlots = ['20:00-21:00', '21:00-22:00'];
                
                let successCount = 0;
                let errorCount = 0;
                
                // Process each week
                for (let i = 0; i < weeksList.length; i++) {
                    const week = weeksList[i];
                    const weekStart = week.monday;
                    
                    log(`\nProcessing week ${i + 1}/${weeksList.length}: ${formatDate(weekStart)}`, 'info');
                    
                    try {
                        // Use batch for this week
                        const batch = database.batch();
                        
                        for (const day of days) {
                            for (const time of timeSlots) {
                                const dayDate = new Date(weekStart);
                                const dayOffset = day === 'tuesday' ? 1 : 3;
                                dayDate.setDate(weekStart.getDate() + dayOffset);
                                const dateStr = formatDateForId(dayDate);
                                const sessionId = getSessionId(dateStr, day, time);
                                
                                const docRef = database.collection('schedules').doc(sessionId);
                                const instructor = day === 'tuesday' ? 'Pa≈°a' : 'Justƒ´ne';
                                
                                // Use template players
                                const defaultPlayers = template[day][time].players || [];
                                
                                // Set (will overwrite if exists)
                                batch.set(docRef, {
                                    date: dateStr,
                                    day: day,
                                    instructor: instructor,
                                    time: time,
                                    players: defaultPlayers,
                                    maxCapacity: 5,
                                    locked: false,
                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                }, { merge: false }); // merge: false ensures complete replacement
                            }
                        }
                        
                        await batch.commit();
                        successCount++;
                        log(`‚úì Week ${i + 1} initialized successfully`, 'success');
                        
                    } catch (error) {
                        errorCount++;
                        log(`‚úó Week ${i + 1} failed: ${error.message}`, 'error');
                    }
                    
                    // Update progress
                    updateProgress(i + 1, weeksList.length);
                    
                    // Small delay to avoid overwhelming Firebase
                    if (i < weeksList.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // Final status
                if (errorCount === 0) {
                    updateStatus(`‚úÖ Complete! Successfully initialized ${successCount} weeks.`, 'success');
                    log(`\nüéâ Initialization complete! ${successCount} weeks initialized.`, 'success');
                } else {
                    updateStatus(`‚ö†Ô∏è Completed with errors. ${successCount} success, ${errorCount} failed.`, 'error');
                    log(`\n‚ö†Ô∏è Initialization complete with errors. ${successCount} success, ${errorCount} failed.`, 'warning');
                }
                
            } catch (error) {
                updateStatus('‚ùå Fatal error: ' + error.message, 'error');
                log(`‚ùå Fatal error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>
